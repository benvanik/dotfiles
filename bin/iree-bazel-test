#!/bin/bash
# Run IREE tests with Bazel.
#
# Usage: iree-bazel-test [target] [bazel-args...]
#
# Examples:
#   iree-bazel-test                       # Run all tests (CPU only)
#   iree-bazel-test //compiler/...        # Test compiler only
#   iree-bazel-test --config=asan         # Test with AddressSanitizer

set -e

# Colors.
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
RED='\033[0;31m'
NC='\033[0m'

info() { printf "${GREEN}[iree-bazel]${NC} %s\n" "$1"; }
warn() { printf "${YELLOW}[iree-bazel]${NC} %s\n" "$1"; }
error() { printf "${RED}[iree-bazel]${NC} %s\n" "$1" >&2; }

show_help() {
    cat << 'EOF'
iree-bazel-test - Run IREE tests with Bazel

USAGE
    iree-bazel-test [target] [bazel-args...]

ARGUMENTS
    target       Bazel target (default: //...)
    bazel-args   Additional arguments passed to bazel test

EXAMPLES
    iree-bazel-test                       # Run all tests (CPU only)
    iree-bazel-test //compiler/...        # Test compiler only
    iree-bazel-test --config=asan         # Test with AddressSanitizer

DEFAULT BEHAVIOR
    - Excludes GPU tests (CUDA, Vulkan, HIP, Metal)
    - Uses local-sync and local-task drivers
    - Continues on test failures (-k)

ENABLING GPU TESTS
    Set environment variables to 0 to ENABLE:
    IREE_VULKAN_DISABLE=0 iree-bazel-test     # Include Vulkan tests
    IREE_CUDA_DISABLE=0 iree-bazel-test       # Include CUDA tests

CONFIGURATIONS
    --config=debug           Debug build tests
    --config=asan            Address Sanitizer
    --config=msan            Memory Sanitizer
    --config=tsan            Thread Sanitizer

SEE ALSO
    iree-bazel-configure, iree-bazel-build
EOF
}

case "${1:-}" in
    -h|--help) show_help; exit 0 ;;
esac

# Find the IREE worktree root (directory with .git and .bazelversion).
find_worktree_root() {
    local dir="$PWD"
    while [ "$dir" != "/" ]; do
        if [ -e "$dir/.git" ] && [ -f "$dir/.bazelversion" ]; then
            echo "$dir"
            return 0
        fi
        dir=$(dirname "$dir")
    done
    return 1
}

# Find worktree root.
WORKTREE_DIR=$(find_worktree_root)
if [ -z "$WORKTREE_DIR" ]; then
    error "Not in an IREE worktree (no .bazelversion found)"
    error "Run from within ~/src/iree/<worktree>/"
    exit 1
fi

cd "$WORKTREE_DIR"

# Check configuration exists.
if [ ! -f "configured.bazelrc" ]; then
    warn "configured.bazelrc not found, running iree-bazel-configure..."
    iree-bazel-configure
fi

# Parse arguments: first non-flag arg is target, rest are bazel args.
TARGET=""
BAZEL_ARGS=()

for arg in "$@"; do
    if [ -z "$TARGET" ] && [[ "$arg" != -* ]]; then
        TARGET="$arg"
    else
        BAZEL_ARGS+=("$arg")
    fi
done

# Default target.
TARGET="${TARGET:-//...}"

# Build tag filters based on environment.
TAG_FILTERS="-nodocker"
BUILD_FILTERS=""

# GPU/hardware test filtering (disabled by default).
CUDA_DISABLE="${IREE_CUDA_DISABLE:-1}"
VULKAN_DISABLE="${IREE_VULKAN_DISABLE:-1}"
HIP_DISABLE="${IREE_HIP_DISABLE:-1}"
METAL_DISABLE="${IREE_METAL_DISABLE:-1}"

if [ "$CUDA_DISABLE" = "1" ]; then
    TAG_FILTERS="$TAG_FILTERS,-driver=cuda,-target=cuda"
    BUILD_FILTERS="$BUILD_FILTERS,-driver=cuda,-target=cuda"
fi
if [ "$VULKAN_DISABLE" = "1" ]; then
    TAG_FILTERS="$TAG_FILTERS,-driver=vulkan"
    BUILD_FILTERS="$BUILD_FILTERS,-driver=vulkan"
fi
if [ "$HIP_DISABLE" = "1" ]; then
    TAG_FILTERS="$TAG_FILTERS,-driver=hip"
    BUILD_FILTERS="$BUILD_FILTERS,-driver=hip"
fi
if [ "$METAL_DISABLE" = "1" ]; then
    TAG_FILTERS="$TAG_FILTERS,-driver=metal"
    BUILD_FILTERS="$BUILD_FILTERS,-driver=metal"
fi

info "Testing $TARGET..."
info "Tag filters: $TAG_FILTERS"

exec bazel test -k "$TARGET" \
    --test_tag_filters="$TAG_FILTERS" \
    --build_tag_filters="$BUILD_FILTERS" \
    --iree_drivers=local-sync,local-task \
    "${BAZEL_ARGS[@]}"
